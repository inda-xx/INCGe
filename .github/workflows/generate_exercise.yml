name: Generate TA Exercise

on: 
    workflow_dispatch:
        inputs:
            subject:
                description: 'Subject for the Exercise'
                required: true
                default: 'Write the subject of your exercise'
            difficulty:
                description: 'Difficulty level for the exercise'
                required: true
                type: choice
                options:
                  - simple
                  - medium
                  - hard
                  - v.hard
                default: medium
            language:
                description: 'Natural language for the exercise description'
                required: true
                default: 'English'
            branch_name:
                description: 'Branch name for this task'
                required: true
                default: 'task-branch'

permissions:
  contents: write  
  pull-requests: write

jobs:
  generate-task-description:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install openai pytz

      - name: Generate task description
        id: generate-task-description
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TASK_SUBJECT: ${{ github.event.inputs.subject }}
          TASK_DIFFICULTY: ${{ github.event.inputs.difficulty }}
          TASK_LANGUAGE: ${{ github.event.inputs.language }}
        run: |
          python scripts/exercise_description.py "${{ secrets.OPENAI_TOKEN }}" "${{ github.event.inputs.subject }}" "${{ github.event.inputs.difficulty }}" "${{ github.event.inputs.language }}"

      # Configure Git user information
      - name: Configure Git
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Create new branch
        run: |
          git checkout -b ${{ github.event.inputs.branch_name }}
          git add tasks/new_task.md
          git commit -m "Add new task description"
          git push origin ${{ github.event.inputs.branch_name }}

  generate-solution:
    runs-on: ubuntu-latest
    needs: generate-task-description
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.branch_name }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install openai pytz

      - name: Generate solution
        id: generate-solution
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/solution_generation.py "${{ secrets.OPENAI_TOKEN }}" "${{ github.event.inputs.branch_name }}"

      # Configure Git user information (again for this job)
      - name: Configure Git
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      # Push the solution back to the same branch
      - name: Push solution to branch
        run: |
          git add tasks/solution.md
          git commit -m "Add solution to task"
          git push origin ${{ github.event.inputs.branch_name }}
